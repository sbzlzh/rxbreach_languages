name: Lang Parser Auto PR

on:
  push:
    paths:
      - 'languages/*.lua'   # 仅当语言文件被更改时触发
  workflow_dispatch:

jobs:
  update_languages:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate GitHub App token
      uses: actions/create-github-app-token@v1
      id: generate-token
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}

    - name: Run language parser
      run: |
        python3 parse.py --in ./languages --out ./languages --base chinese --ignore chinese

    - name: Commit language updates
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: '[bot] Auto-sync missing translations using chinese.lua'
        branch: ci-update-language-files
        file_pattern: 'languages/*.lua'
        push_options: '--force'  # 可选：强制推送
        commit_user_name: LangBot
        commit_user_email: bot@example.com
        commit_author: LangBot <bot@example.com>
        token: ${{ steps.generate-token.outputs.token }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ steps.generate-token.outputs.token }}
        commit-message: '[bot] Auto-sync missing translations using chinese.lua'
        branch: ci-update-language-files
        title: '[LangBot] Auto-update language files'
        body: |
          This PR was automatically generated by LangBot using chinese.lua as the base language.
        delete-branch: true
