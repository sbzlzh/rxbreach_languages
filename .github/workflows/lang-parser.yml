name: Lang Parser Auto PR

on:
  push:
    paths:
      - 'languages/*.lua'
  workflow_dispatch:

jobs:
  update_languages:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate GitHub App token
      uses: actions/create-github-app-token@v1
      id: generate-token
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}

    - name: Run language parser
      run: |
        python3 parse.py --in ./languages --out ./languages --base chinese --ignore chinese

    - name: 创建独立分支用于 PR
      run: |
        git config user.name "LangBot"
        git config user.email "bot@example.com"
        git checkout -b ci-update-language-files

    - name: Commit language updates
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: '[bot] Auto-sync missing translations using chinese.lua'
        file_pattern: 'languages/*.lua'

    - name: Push branch and set upstream
      run: |
        git push --set-upstream origin ci-update-language-files

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ steps.generate-token.outputs.token }}
        branch: ci-update-language-files
        base: master
        commit-message: '[bot] Auto-sync missing translations using chinese.lua'
        title: '[LangBot] Auto-update language files'
        body: |
          This PR was automatically generated by LangBot using chinese.lua as the base language.
        delete-branch: true
